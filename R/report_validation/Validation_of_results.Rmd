---
title: "Report Validation of results"
output:
  html_document:
    toc: true
    toc_float: true
---

## Validation of results

Our results showed that humans have little effect on composition of ecosystem properties over time and the conclusion based on the our results are that past humans have not significantly changed ecosystem properties in the past. 

However, this raise some questions and these are:
1. How does the composition of ecosystem properties look like, and are there any changes in the composition of ecosystem properties over time?
2. How do the spd look like, and are they useful indices of past humans?
3. Are our analyses robust and can we have good confidence in the results?

## Methods

To answer these questions, we have added some explorative analyses of the ecosystem properties to try to get a better visual understanding of the data. 

To address the first question how the composition of ecosystem properties look like and to find out if there are any changes in composition of ecosystem properties, we have performed unconstrained PCOA (or db-PCA) using Gower distances, and plotted the first PCOA axis with time for the individual records (but aggregated within Ecozones to avoid too many figures). We also explore the spds by plotting them with time to see how they look like.

To find out if spds are able to explain any changes in the data, we use multivariate regression trees (MRT). The response data is the composition of ecosystem properties transformed with Gower- distances and the constraining variables are time and spd. We used MRTs as these are easy tools that can handles non-linear patterns and missing data. We combine the results of the MRT partition with the PCOA (unconstrained data) to explore the unconstrained data and get a better understanding of the differences in the ecosystem properties. 

We use only the subset of Europe for exploration. The analyses are run three times on different scales: 1) for all records individually (396 individual records), 2) for records nested within ecozones (4 subsets), and 3) whole region (the full subset).

The results of the individual PCOA analysis of each record is not shown. Instead the first PCOA axis is plotted against time to see if there are changes in the composition of ecosystem properties over time. 

The overall results of the MRTs for individual records are summaried in tables. 

For the analysis of the records nested within ecozones and for the whole region, we extract the significant partitions from the MRT analyses, and explore the results using ordination diagrams. In addition, we passively fit the explanatory variables, time and spds, to the ordination models to help explore the results. 


## Results

```{r echo = FALSE, warning = FALSE, message = FALSE}

library(tidyverse)
library(usethis)
library(targets)
library(here)
library(colorspace)
library(colorBlindness)
library(data.tree)
library(kableExtra)
library(htmltools)

# list R functions and source them
lapply(
  list.files(
    path = here::here("R/functions"),
    pattern = "*.R",
    recursive = TRUE,
    full.names = TRUE
  ),
  source
) %>%
  invisible()

auth_tibble <-
  tibble::tibble(
    name = c("ondre", "omo084", "vfe032", "vfe032", "sfl046", "kbh022"),
    paths = c(
      "C:/Users/ondre/OneDrive - University of Bergen/HOPE_data/",
      "C:/Users/omo084/OneDrive - University of Bergen/HOPE_data/",
      "/Users/vfe032/Library/CloudStorage/OneDrive-SharedLibraries-UniversityofBergen/Ondrej Mottl - HOPE_data/",
      "C:/Users/vfe032/OneDrive - University of Bergen/HOPE_data_copy/",
      "C:/Users/sfl046/University of Bergen/Ondrej Mottl - HOPE_data/",
      "C:/Users/kbh022/University of Bergen/Ondrej Mottl - HOPE_data/"
    )
  )

sys_info <- Sys.info()

username <-
  sys_info["user"]

data_storage_path <-
  auth_tibble %>%
  dplyr::filter(name == username) %>%
  purrr::pluck("paths")

if (length(data_storage_path) > 1) {
  data_storage_path <- data_storage_path[2]
}

external_storage_targets <-
  paste0(
    data_storage_path,
    "HOPE_Hypothesis1/_targets1"
  )

# set configuration for _target storage
tar_config_set(
  store = external_storage_targets
)


min_age <- 0
max_age <- 12e3
timestep <- 500

# set colours 
#colours <- protan(rainbow_hcl(5, start = 30, end = 300))
#scale_fill_manual(values=colours) 

#scale_fill_hue(c = 50, l = 70, h=c(30, 300)) # light
#scale_fill_hue(c = 50, l = 50, h=c(30, 200)) # dark

```



```{r echo = FALSE}
#load saved data
results_hvar_temporal <- read_rds("C:/Users/vfe032/Documents/Github/HOPE_Hypothesis1/results_hvar_temporal.rds")
results_hvar_spatial <- read_rds("C:/Users/vfe032/Documents/Github/HOPE_Hypothesis1/results_hvar_spatial.rds")

# filter subset Europe and relevant time period
subset_europe <- results_hvar_spatial %>%
  inner_join(tar_read(data_meta) %>% 
               dplyr::select(dataset_id, ecozone_koppen_5, region), 
             by = "dataset_id") %>%
  dplyr::filter(region == "Europe") %>%
  unnest(data_merge) %>%
  filter(age >= 2000 & age <= 8500) %>%
  nest(data_merge = c(age:spd))


```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.show='hide'}

subset_europe2 <- subset_europe %>%
  dplyr::mutate(mvpart = 
                  purrr::map(data_merge,  
                             .f = ~get_mvpart_model(., plot.add = FALSE))) %>%
  dplyr::mutate(pcoa_mod = 
                  purrr::map(data_merge,
                                      .f = get_pcoa_model))

```





```{r echo = FALSE , warning = FALSE, message = FALSE, fig.show='hide'}

subset_europe3  <- subset_europe2 %>%
  dplyr::select(dataset_id, ecozone_koppen_5, data_merge) %>%
  unnest(data_merge) %>%
  nest(data_merge = c(dataset_id, age:spd)) %>%
  mutate(mvpart = purrr::map(data_merge, .f = get_mvpart_model)) %>%
  mutate(pcoa_mod = purrr::map(data_merge, .f = get_pcoa_model))

```



```{r echo = FALSE, warning = FALSE, message = FALSE, fig.show='hide'}

full_dataset_europe <- subset_europe %>% 
  dplyr::select(-c(varhp)) %>%
  unnest(data_merge) %>%
  nest(data = -region) %>%
  mutate(mvpart = purrr::map(data, .f = ~ get_mvpart_model(., plot.add = FALSE))) %>%
  mutate(pcoa_mod = purrr::map(data, .f = get_pcoa_model))

```


### 1. Results from the analyses of individual records

```{r echo = FALSE, , warning = FALSE, message = FALSE}
#functions to extract summaries
get_pcoa_score <- function(mod) {
  sc <- vegan::scores(mod, choices = 1, display = "sites") 
  sc_const <- sc + attr(sc,"const")
  return(sc_const) 
}

get_data_for_exploration <- function(data, pcoa1) {
  new <- data.frame(age = data$age,
                    spd = data$spd,
                    pcoa1 = pcoa1)
  return(new)
}

get_sum_table_mrt <- function(mod, data){
 table <-  data.frame(
   tot_divisions = mod$where %>% unique %>% length(),
   age_var = any((mod$frame$var == "age") == TRUE),
   spd_var = any((mod$frame$var == "spd") == TRUE),
   spd_in = is.null(data$spd) == FALSE
 )
 return(table)
}

# create dataset for exploration 
subset_europe2  <- subset_europe2 %>%
  mutate(pcoa1 = purrr::map(pcoa_mod, .f = possibly(get_pcoa_score, 
                                                    otherwise = NA_real_))) %>% 
  mutate(data_explore = purrr::map2(data_merge, pcoa1, .f = get_data_for_exploration)) %>%
  mutate(mrt_summary = purrr::map2(mvpart, data_merge, .f = get_sum_table_mrt))

# extract summary table
summary_mrt_table <- subset_europe2 %>%
  dplyr::select(dataset_id, ecozone_koppen_5, mrt_summary) %>%
  unnest(mrt_summary)

# numbers based on individual records by ecozones
summarise_by_ecozone <- summary_mrt_table %>%
  group_by(ecozone_koppen_5) %>%
  summarise(tot_records = n(),
            spd_true =  sum(spd_var == TRUE),
            age_true = sum(age_var == TRUE),
            spd_unique = sum(spd_var == TRUE & age_var == FALSE),
            age_unique = sum(age_var == TRUE & spd_var == FALSE),
            spd_age_true = sum(spd_var == TRUE & age_var == TRUE)
            ) %>%
  pivot_longer(spd_true:spd_age_true, names_to = "variable", values_to = "counts") %>%
  mutate(percent = counts/tot_records*100)

```



The summary results of the first PCOA axis against time show there are changes in the composition of ecosystem properties over time for individual sites (Figure 1). To see how spds represented as past human population vary across records, the individual curves are plotted against time between 2000 and 8500 years BP (Figure 2). First inspections looks reasonable.


```{r echo = FALSE, warning = FALSE, message = FALSE}
# figure 1, MDS1 vs time
mds_fig <- subset_europe2 %>%
  dplyr::select(dataset_id, ecozone_koppen_5, data_explore) %>%
  unnest(data_explore) %>%
  ggplot(aes(x = age, y = MDS1, group = dataset_id)) +
  scale_x_reverse() +
  coord_flip() +
  geom_line(aes(col = as.numeric(dataset_id)),alpha = 0.3, linewidth = 1) +
  scale_colour_gradient2(low = "yellow2", mid = "orange3", high = "darkgreen")+
  facet_wrap(~ecozone_koppen_5, nrow = 1) +
  theme_bw()+
  theme(
    legend.position = "none"
  ) +
  labs(title = "PCOA axes 1 for individual records",
       y = "Values",
       x = "Age ca. BP")

mds_fig 

```


Figure 1: Plot of the individual PCOA axis 1 for all records against time. 



```{r echo = FALSE}
# figure 1, MDS1 vs time
spd_fig <- subset_europe2 %>%
  dplyr::select(dataset_id, ecozone_koppen_5, data_explore) %>%
  unnest(data_explore) %>%
  ggplot(aes(x = age, y = spd, group = dataset_id )) +
  geom_line(aes(col = as.numeric(dataset_id))) +
  scale_x_reverse() +
  coord_flip() +
  #scale_colour_gradient2()+
  facet_wrap(~ecozone_koppen_5, nrow = 1) +
  theme_bw() +
  theme(
    legend.position = "none"
  ) +
  labs(title = "SPD curves for individual records",
       y = "Values",
       x = "Age ca. BP")

spd_fig


```


Figure 2: Plot of the individual spd curves representing changes in past human population for all records over time. 




The results of the MRT are summaried in one figure and two tables below. Overall the results of the MRT analyses show that it is possible to detect major changes in the composition of ecosystem properties explained by time and humans. Only one record show no change, most records have either two or three major significant divisions, whereas a few records show 4 significant divisions (Figure 3). 



```{r echo = FALSE, warning = FALSE, message = FALSE}

summary_mrt_table %>% 
 # filter(spd_var == TRUE) %>%
  ggplot(aes(x = tot_divisions, fill = ecozone_koppen_5)) +
  geom_bar() +
  theme_bw()

```


Figure 3: Number of records with different divisions representing signifcant changes in ecosystem properties explained either by time, humans or both. The records are coloured by ecozones. 

Two tables below are created to give a simple summary of the MRT results, first table summarise the counts in total whereas the second table show the numbers within ecozones. 

The total number of records are counted for: 

- spd explains the significant partitions (spd_true) 
- age explains the significant partitions (age_true)
- only spd explains the significant partition (spd_unique)
- only age explains the significant partition (age_unique)
- where both age and humans explains the significant partitions (spd_age_true)


Table 1: Summarises the total number and percentage for the whole region Europe of records analyses where age, humans, or both variables explains most of the changes as observed the MRTs.

```{r echo = FALSE}
# summarise number of records with division based on spd and age 
# numbers based on individual records for total European subset
summarise_by_all <- summary_mrt_table %>%
  summarise(tot_records = n(),
            spd_true =  sum(spd_var == TRUE),
            age_true = sum(age_var == TRUE),
            spd_unique = sum(spd_var == TRUE & age_var == FALSE),
            age_unique = sum(age_var == TRUE & spd_var == FALSE),
            spd_age_true = sum(spd_var == TRUE & age_var == TRUE)
  ) %>%
  pivot_longer(spd_true:spd_age_true, names_to = "variable", values_to = "counts") %>%
  mutate(percent = counts/tot_records*100)

summarise_by_all %>%
  kbl(booktabs = TRUE, caption = "Table 1: Summary of MRT results", align = "l") %>%
  kable_paper(full_width = FALSE)

```


Table 2: Summarises the total number and percentages for records in the different ecozones where age, humans, or both variables explains most of the changes as observed the MRTs.

```{r echo = FALSE}
# numbers based on individual records by ecozones
summarise_by_ecozone <- summary_mrt_table %>%
  group_by(ecozone_koppen_5) %>%
  summarise(tot_records = n(),
            spd_true =  sum(spd_var == TRUE),
            age_true = sum(age_var == TRUE),
            spd_unique = sum(spd_var == TRUE & age_var == FALSE),
            age_unique = sum(age_var == TRUE & spd_var == FALSE),
            spd_age_true = sum(spd_var == TRUE & age_var == TRUE)
            ) %>%
  pivot_longer(spd_true:spd_age_true, names_to = "variable", values_to = "counts") %>%
  mutate(percent = counts/tot_records*100)

summarise_by_ecozone %>%
  kbl(booktabs = TRUE, caption = "Table 2: Summary of individual MRT results nested by ecozones", align = "l") %>%
  kable_paper(full_width = FALSE)

```




### 2. Results for the analyses with records nested in ecozones

 

```{r echo = FALSE, warning = FALSE, message = FALSE}
plot_results <- function(mrt_mod, pcoa_mod, data_merge, ecozone) {
  
  splits <- mrt_mod$where
  
  splits <- data.frame(splits) %>% 
    rownames_to_column("label") 
  
  scors <- vegan::scores(pcoa_mod, tidy = TRUE)
  
  fit_exp <- vegan::envfit(pcoa_mod, data_merge %>% 
                             dplyr::select(age, spd), perm = 999)
  
  fit_exp_scors <- vegan::scores(fit_exp, "vectors") * vegan::ordiArrowMul(fit_exp) 
  
  fit_exp_scors <- fit_exp_scors %>% 
    as.data.frame() %>%
    rownames_to_column("names")
  
  site_scors <- scors %>%
    filter(score == "sites") %>%
    inner_join(splits, by = "label") %>%
    mutate(splits = as.factor(splits))
  
  pcoa_plot <- 
    ggplot(data = site_scors, 
           aes(x = MDS1, 
               y = MDS2, 
               col = splits, 
               fill = splits, 
               shape = splits)) +
    coord_fixed() +
    stat_ellipse(type = "norm", linetype = 2) + 
    stat_ellipse(geom = "polygon", type = "t", alpha= 0.3) +
    geom_point(size = 2) +
    ggplot2::geom_segment(data = fit_exp_scors, 
                          aes(x = 0, xend = MDS1, y = 0, yend = MDS2), 
                          inherit.aes = FALSE, arrow = arrow(length = unit(0.25, "cm")), colour = "black") +
    ggplot2::geom_text(data = fit_exp_scors, 
                       aes(x = MDS1, y = MDS2, label = names), 
                       inherit.aes = FALSE, colour = "navy", fontface = "bold") +
    theme_bw() +
    labs(title = paste("Ecozone", ecozone))
  
  pcoa_plot 
 
}

get_envfit <- function(mod, data, ...) {
  fit_exp <- vegan::envfit(mod, data %>% 
                             dplyr::select(age, spd))
  fit_exp
  
}

subset_europe3 <- subset_europe3 %>%
  mutate(envfit = purrr::map2(pcoa_mod, data_merge, .f = get_envfit)) %>%
  mutate(pcoa_fig = purrr::pmap(list(mvpart, 
                                pcoa_mod,
                                data_merge,
                                ecozone_koppen_5),
                                .f = ~ plot_results(mrt_mod = ..1,
                                                  pcoa_mod = ..2, 
                                                  data_merge = ..3,
                                                  ecozone = ..4)
              ))

```


Figures 4-7 display the ordination diagrams of the unconstrained PCOA using Gower-distances for each of the ecozones in Europe. The samples are coloured by the significant MRT partitions for the same dataset. The constraining variables age and humans are then passively fitted to the PCOA model using envfit. This means it has no direct effect on the sample scores, but shows how well correlated these variables are with PCOA axis 1 and 2. The length and direction of the arrow indicate which axes it has best correlation with. 


```{r echo = FALSE, warning = FALSE, message = FALSE}
subset_europe3$pcoa_fig[[1]]

```


Figure 4. PCOA diagram for records in the Cold ecozone with significant MRT division display by the colours and ellipses. The MRT show the data is partition into 2 major groups, where humans (spd) is the most important predictor for this division (spd>= 0.2645 and spd < 0.2645).


```{r echo = FALSE, warning = FALSE, message = FALSE}
subset_europe3$pcoa_fig[[2]]

```


Figure 5. PCOA diagram for records in the Temperate ecozone with significant MRT division display by the colours and ellipses. The MRT shows 2 major partitions determined by age (age >= 5250 and age < 5250).


```{r echo = FALSE, warning = FALSE, message = FALSE}

subset_europe3$pcoa_fig[[3]]

```

Figure 6. PCOA diagram for records in the Polar ecozone with significant MRT division display by the colours and ellipses. The MRT indicates 4 significant partitions. The first is determined by spd >= 0.228 and spd < 0.228, second one is determined by spd< 0.07 & spd >0.07, the final split is determined by age < 7750 and >= 7750. 

```{r echo = FALSE}
subset_europe3$pcoa_fig[[4]]

```

Figure 7. PCOA diagram for records in the Arid ecozone with significant MRT division display by the colours and ellipses. 


The following list show the results of the envfit with the PCOA model and age and time. The numbers are: 1 = Cold ecozone, 2 = Temperate ecozone, 3 = Polar ecozone, 4 = Arid ecozone. 

```{r echo = FALSE}
subset_europe3$envfit

```


### 3. Results for the analyses with records nested in Europe

The next figure show the results for all records in one analyses for Europe. 


```{r echo = FALSE, warning = FALSE, message = FALSE}



full_dataset_europe <- full_dataset_europe %>%
  mutate(envfit = purrr::map2(pcoa_mod, data, .f = get_envfit)) %>%
  mutate(pcoa_fig = purrr::pmap(list(mvpart, 
                                     pcoa_mod,
                                     data,
                                     region),
                                .f = ~ plot_results(mrt_mod = ..1,
                                                    pcoa_mod = ..2, 
                                                    data_merge = ..3,
                                                    ecozone = ..4)
  ))

full_dataset_europe$pcoa_fig[[1]]

```

Figure 8. PCOA ordination diagram with all records and samples within Europe.


The results of the envfit of the PCOA model with time and humans.


```{r echo = FALSE, warning = FALSE, message = FALSE}
full_dataset_europe$envfit[[1]]

```
 
 
### Interpretations


For the summary of the individual records, past humans (spd) is important explaining MRT partitions in 17.2 % of the records, whereas in 9.85 % of the record, it is uniquely explaining the partitions. Time is explaining most of the MRT partitions in the individual records, and it is uniquely explaining the variation in 82.6 % of the individual records (for comparison with numbers in the different ecozones, see Table 2). 


When analysing the data on larger spatial scale as records nested within the ecozones, the results show that past humans have affected the fundamental ecosystem properties in the Cold and Polar ecozones. Changes in the Polar region is more complex, and time dependent factors are also important in the partitioning, whereas in the Temperate and Arid ecozones, time is the most important variable for the variation of the data.  

When putting all the records together, it becomes visible that overall differences in composition of ecosystem properties in Europe are better explained by past humans compared to time in Europe. Past human activity seems to have started a shift in the composition of ecosystem properties in the another direction, and this is determined by the average threshold spd>= 0.2555 & spd < 0.2555.  

This is interesting, because local changes explained by humans in smaller percent of the records, have had an effect on ecosystem properties that overrides the variation in ecosystem properties explained by time.

Though past humans seems to have effected the composition of past ecosystem properties, the MRTs have a high prediction error (CV error ~ 0.9). You can see this in the PCOA diagram where most of the samples overlap. The results does not indicate that we will find that they statistically significantly alter fundamental ecosystem properties of the past, but past human activity did have an impact. 


Summary:

1. The results show that there are changes in the composition of ecosystem properties over the time period of interest
2. The index of past humans looks reasonably - there are changes in spd and this vary with different records
3. Past human (spds) are able to explain changes in the composition of ecosystem properties using MRTs
4. The MRTs indicate that past humans have had an effect on ecosystem properties, but the results have a bad prediction power   
5. It seems that MRTs are useful tools for summarising results on different spatial scales. 



### For discussion

Personally, I do not think these results disvalidate the other results that past humans did not have a significant effect on the variation of past ecosystem properties, but I think these results shows that past humans have had an effect that is not negligible. The variation explained in the MRTs are low, but I think this change the story a bit. 

Potential message: 
Past humans have not significantly transformed the fundamental ecosystem properties within the time period of 2000 and 8500 years, but they have had an observed impact that indicate that past humans started to a shift of the ecosystem properties in a new direction. 

Question is if I should explore this further?
How to deal with the time order dependency of the data? 

I have a suggestion for a new experimental alternative analysis:

1. Do db-RDA of individual records using time as constraint
2. Take the residuals of these models
- This would then "remove" variation explained by time for individual records
3. Use the residuals as input in the MRT constrained by spds (and possible climate) nested within ecozones
4. This will be the same as the spatial within core analyses (but averaged with ecozones)
5. To do this over time, one suggestion is to first create the MRTs with time, and then use the partitions as subset and constrain the data with spds.  


I will rerun the preliminary analyses to cross check the results again, one major difference here is that I use data 2000-8500 years, and not up to 12000 years.



