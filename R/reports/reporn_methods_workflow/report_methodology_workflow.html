<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Report methodology step-by-step</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="report_methodology_workflow_files/libs/clipboard/clipboard.min.js"></script>
<script src="report_methodology_workflow_files/libs/quarto-html/quarto.js"></script>
<script src="report_methodology_workflow_files/libs/quarto-html/popper.min.js"></script>
<script src="report_methodology_workflow_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="report_methodology_workflow_files/libs/quarto-html/anchor.min.js"></script>
<link href="report_methodology_workflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="report_methodology_workflow_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="report_methodology_workflow_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="report_methodology_workflow_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="report_methodology_workflow_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Report methodology step-by-step</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The objective of this report is to give an detailed description of individual steps of the data analysis</p>
<section id="pollen-data-aquisition" class="level1">
<h1>Pollen data aquisition</h1>
<section id="fossilpol" class="level2">
<h2 class="anchored" data-anchor-id="fossilpol">FOSSILPOL</h2>
<p>The compilation of a pollen dataset for our analysis is performed a priori. Raw pollen datasets are carefully selected with the <em>R-Fossilpol</em> package, and the guidelines to the workflow are well described in Flantua et al.&nbsp;2023 and in our website <a href="https://hope-uib-bio.github.io/FOSSILPOL-website/about.html">Fossilpol project</a>. Most datasets are obtained from the <a href="https://www.neotomadb.org">Neotoma Paleoecology Database</a>. Some additional data are from private owners in areas with data gaps, which we have limited access to use. We do not have the intellectual property rights to make these data public available. Therefore, only the derivatives of the analysis can be publicly shared. Table 1 provides a summary of the settings used in the FOSSILPOL workflow to obtain a standardised project dataset. This input data are further filter during the data processing steps in HOPE to get the final collection of a standardized dataset of high data quality we can use further in our data analyses.</p>
<section id="harmonisation-tables" class="level3">
<h3 class="anchored" data-anchor-id="harmonisation-tables">Harmonisation tables</h3>
<p>An important step in FOSSILPOL to obtain a standardised pollen data set within and across regions is the harmonisation of pollen types. Different analysts have different backgrounds and schools using different nomenclature, and the level of pollen taxonomic identifications and names can vary widely. To be able to make numerical comparisons of different pollen records, the level of pollen taxonomy should be similar. Consequently, pollen harmonisation tables have been produced for different regions to try to minimise biases related to this. The regional harmonisation tables created in our project are for Europe, Levant, Siberia, Southern Asia, Northern America, Latin America, and the Indo-Pacific region (Birks et al.&nbsp;harmonisation paper). These tables are used as input in the Fossilpol workflow above (<a href="https://hope-uib-bio.github.io/FOSSILPOL-website/step_by_step_guide.html">see Fossilpol step_by_step guide</a>). <br></p>
</section>
<section id="data-pollen-assembly" class="level3">
<h3 class="anchored" data-anchor-id="data-pollen-assembly">Data pollen assembly</h3>
<p>We have applied a number of filtering criteria to obtain as high a data quality as possible so that we can compare the numerical estimates on standardised data sets. These filtering criteria are: remove potentially duplicated pollen records, sorting levels (samples) by age, remove levels (samples) lower than a threshold of total number pollen grains counted (= pollen sum), remove pollen records based on age (minimum and maximum age ranges), remove levels (samples) depending on the age of the last control point, remove samples beyond the age ranges of interest, and remove pollen records if the total number of samples (N) is too low.</p>
<p>This filtering is done on the chronologies, raw pollen counts, harmonised pollen counts, and the age uncertainties from the age-depth models (Bchron). The preferable number of minimum pollen grains is set to 150, but this led to a great loss of datasets in regions with less data coverage, and we therefore reduced this number to 25 with the condition that less than 50 % of the samples must have a low pollen sum. This allow us to keep more datasets, but in the cases pollen records have a low minimum pollen sum, we acknowledge that the estimates of pollen assemblage properties (PAPs) are less robust. The maximum age beyond extrapolation is set to 3000 years because ages extrapolated beyond this threshold is considered highly uncertain. Finally, pollen records with less than 5 samples are removed for further analyses.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20data%20pollen%20spatial%20distribution-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20data%20pollen%20spatial%20distribution-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20data%20pollen%20temporal%20distribution-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20data%20pollen%20taxa-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="example-record" class="level2">
<h2 class="anchored" data-anchor-id="example-record">Example record</h2>
<p>Let’s select a one record and use it as an example.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20example%20record-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="detection-of-past-human-presence" class="level1">
<h1>Detection of past human presence</h1>
<p>To determine the impact of past humans on fundamental ecosystem properties, we need to develop indicators of past human presence and activity. This led to the development of a new method, where we use human event detection and indicators identified from pollen records based on expert knowledge, combined with the method for quantifying human presence based on radiocarbon dates derived from archaeological artifacts and Summed Probability Densities (SPD) (Bird et al.&nbsp;2022). We believe that this solves the issue that we can use a standardised variable as indicator of past human impact, and partially avoids the difficulty of creating standardised variables to detect human disturbance events across different regions and continents. This may reduce the potential circularity of human detection events derived from the same pollen records as the estimates of ecosystem properties.</p>
<section id="detection-of-human-events" class="level2">
<h2 class="anchored" data-anchor-id="detection-of-human-events">Detection of human events</h2>
<p>For each pollen record, we have detected periods of human presence from the pollen data. Two methods have been used:</p>
<ol type="1">
<li>detection from pollen diagrams (North America, Europe, Asia, Indopacific)</li>
<li>detection using indicator taxa (Latin America).</li>
</ol>
<section id="detection-of-human-events-in-pollen-diagrams" class="level3">
<h3 class="anchored" data-anchor-id="detection-of-human-events-in-pollen-diagrams">Detection of human events in pollen diagrams</h3>
<p>First, a pollen diagram of each pollen record has been examined by a regional expert and the age of each event type has been recorded.</p>
<div class="cell" data-layout-align="center" data-tbl-cap="Table 2 Type of human events identified in pollen diagrams">
<pre><code>#&gt; 
#&gt; ------------------------------------------------
#&gt;     Region                 Event.type           
#&gt; --------------- --------------------------------
#&gt;  North America   BI = Before Impact; FC = First 
#&gt;                    Cultivation; ES = European   
#&gt;                            Settlement           
#&gt; 
#&gt;     Europe       BI = Before Impact; FI = First 
#&gt;                     Indication; FCu = First     
#&gt;                   Cultivation; EC = Extensive   
#&gt;                     Clearance; CC = Complete    
#&gt;                            Clearance            
#&gt; 
#&gt;      Asia        BI = Before Impact; FI = First 
#&gt;                     Indication; FCu = First     
#&gt;                   Cultivation; EI = Extensive   
#&gt;                              Impact             
#&gt; 
#&gt;   Indopasific    no_impact = No Impact; weak =  
#&gt;                   Weak Impact; medium = Medium  
#&gt;                  Impact; strong = Strong Impact 
#&gt; ------------------------------------------------
#&gt; 
#&gt; Table: Table 2: Type of human events identified in pollen diagrams</code></pre>
</div>
<p>Note that the event types are uniquely defined within continents, and event types with the same name have different meanings between continents.</p>
<p>Second, an algorithm is made to obtain the binary variables (0/1) associated with each event type that is identified in each pollen record. A new vector with the average ages in between levels (samples) of the identified event type was created because the time of the events is assumed to have occurred prior to the changed event. A new matrix was created that uses the new age vector with the events type. The different event types are assigned binary values (0/ 1) depending on if the event type is present (i.e.&nbsp;when the age of the specific event is detected). Ultimately, logical principles were followed and the binary values were adjusted to get the event data for each pollen record. If no human event is recognised, it does not necessarily mean that humans were absent, but instead that there was not enough information to identify human activity in the pollen records.</p>
<p>Below is a figure that intends to represent the data associated with human events in example record. The different colours represent the differnet types of human events in each region. The smooth trend lines represent simple binomial GAM models that show the main trends and alteration in the timing of events over time.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20events-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="arcehological-artefacts-and-summed-probability-densities" class="level2">
<h2 class="anchored" data-anchor-id="arcehological-artefacts-and-summed-probability-densities">Arcehological artefacts and Summed Probability Densities</h2>
<p>The quantification of <em>summed probability distribution</em> (SPD). requires a distance to be selected around each site location to collect the relevant dates of archaeological artefacts around it. This will limit the area of human presence and indirectly the amount of human activity relevant to pollen records from each site.</p>
<p>We used the global dataset of radicarbon dates (RC dates) of archeological artefacts from Bird et al.&nbsp;2022.</p>
<p>We have gathered all radiocarbon dates up to 500 km away and split them into groups (categories) by the distance to the sequence.</p>
<p>Only RC dates with valid geographical location (longitude and latitude), and ‘LocAccuracy’ &gt; 0 were selected. For each pollen record, RC dates were classified by the geographical distance to the pollen record. The chosen distance classes were: 5, 25, 50, 100, 250, 500 km. For each distance category, we used all RC dates up to the maximum distance of selected category. For example, <code>250</code> contains all RC dates up to 250 km including <code>5</code>, <code>25</code>,…</p>
<p>However, distance class with less than (250 RC dates) (a <em>Threshold</em>) is filtered out in order to maintain robust SPD estimation.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20C14%20for%20exmple%20record-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="estimation-of-spd" class="level3">
<h3 class="anchored" data-anchor-id="estimation-of-spd">Estimation of SPD</h3>
<p>For each distance category, SPD is estimated using <code>spd</code> function from <code>rcarbon</code> package for each distance class for each year between a minimum threshold age and 12 ka.</p>
<p>Radiocarbon dates were calibrated using <code>calibrate</code> function from <code>rcarbon</code> package with appropriate calibration curves (“IntCal20”, “ShCal20”, “mixed”). Calibration curves were obtained <code>rcarbon</code> package and “mixed” was created using <code>rcarbon::mixCurves</code> function with ‘p’ = 0.5. Calibration curves were assigned by their geographical location following Hua et al., 2013.</p>
<p>For the selected seqeunces <strong>intcal20</strong> have been used.</p>
<p>The temporal distribution of SPDs constructed by diferent distances:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20temporal%20spd%20trend-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="regional-age-cutoff" class="level3">
<h3 class="anchored" data-anchor-id="regional-age-cutoff">Regional age cutoff</h3>
<p>The minimum threshold ages are different for different regions and are decided based on the availability of radiocarbon dating for different regions. In general there is a bias that radiocarbon dating is rather limited on younger material where in many regions there are a lack of C14 data during the last 2000 years. Table 5 show the ages where data younger than age_from where removed.</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt; 
#&gt; --------------------------
#&gt;     region       age_from 
#&gt; --------------- ----------
#&gt;     Europe         2000   
#&gt; 
#&gt;  Latin America     2000   
#&gt; 
#&gt;      Asia          2000   
#&gt; 
#&gt;  North America     500    
#&gt; 
#&gt;     Oceania        500    
#&gt; --------------------------</code></pre>
</div>
</section>
<section id="selection-of-the-distance" class="level3">
<h3 class="anchored" data-anchor-id="selection-of-the-distance">Selection of the distance</h3>
<p>In order to select the <em>best distance</em>, we want to know, which SPD curve is the best at explaining the changes in pollen events.</p>
<p>Therefore, for each distance, we calculated <em>Redundancy Analysis</em> (RDA) with individual event values as response and SPD as predictors.</p>
<p>Here is a visualisation of the data to fit:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/plot%20joined%20sdp%20&amp;%20events-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Or in a form of table:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt; 
#&gt; ----------------------------------------------------------------------------
#&gt;  age    no impact   first impact   extensive clearince   complete clearince 
#&gt; ------ ----------- -------------- --------------------- --------------------
#&gt;  3790       0            1                  0                    0          
#&gt; 
#&gt;  6767       1            0                  0                    0          
#&gt; 
#&gt;  7015       1            0                  0                    0          
#&gt; 
#&gt;  7262       1            0                  0                    0          
#&gt; 
#&gt;  7869       1            0                  0                    0          
#&gt; 
#&gt;  8236       1            0                  0                    0          
#&gt; ----------------------------------------------------------------------------
#&gt; 
#&gt; Table: Table continues below
#&gt; 
#&gt;  
#&gt; ----------------------------------------------------------
#&gt;  first cultivation     50        100       250      500   
#&gt; ------------------- --------- --------- --------- --------
#&gt;          0           0.02323   0.06117   0.2413    0.9766 
#&gt; 
#&gt;          0           0.01443   0.0655    0.3516    1.124  
#&gt; 
#&gt;          0           0.01545   0.05377   0.2674    0.9394 
#&gt; 
#&gt;          0           0.01738   0.04415   0.2374    0.673  
#&gt; 
#&gt;          0           0.01178   0.02182   0.1267    0.2665 
#&gt; 
#&gt;          0           0.00652   0.01761   0.08569   0.2014 
#&gt; ----------------------------------------------------------</code></pre>
</div>
<p>We can plot the individual ordianation but it is not very informative. The size and ocupancy of points corespond with their age.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/RDA%20ordination-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="r2" class="level4">
<h4 class="anchored" data-anchor-id="r2">R2</h4>
<p>We can evaluate the amount of variability explained by each ordination. We then extracted adj.r2 for each SPD distnce:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/RDA%20R2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Therefore we have selected <strong>500</strong> as the best distance and the prefered SPD curve for <strong>4197</strong> sequence</p>
</section>
</section>
</section>
<section id="selecting-best-distance-per-continent" class="level2">
<h2 class="anchored" data-anchor-id="selecting-best-distance-per-continent">Selecting best distance per continent</h2>
<p>Here is a overview of the status of records base on the presence of humna impact from pollen diagrams and RC data</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/status%20of%20records%20based%20on%20events%20and%20rc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can apply the selection of best distance to all sequences which fullfil such criteria: 1. Have events 2. Have at least one SPD constructed</p>
<p>We can summary the <em>best distance</em> per each continent</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/region_summary-geo-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/best%20distance%20region%20summary%20plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>